<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator NPK v39 (Zaawansowany)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/javascript-lp-solver/prod/solver.js"></script>
    <!-- Dodane biblioteki -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Style bez zmian */
        input[type="radio"]:checked + span { color: theme('colors.indigo.700'); font-weight: 600; }
        label.radio-label:has(input[type="radio"]:checked) { background-color: theme('colors.indigo.50'); border-color: theme('colors.indigo.300'); }
        .tooltip { position: relative; display: inline-block; cursor: help; vertical-align: middle; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 5px; position: absolute; z-index: 50; bottom: 135%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .info-icon { display: inline-block; width: 16px; height: 16px; background-color: #a0aec0; color: white; border-radius: 50%; text-align: center; font-size: 12px; line-height: 16px; font-weight: bold; margin-left: 4px; }
        #progressBarFill { transition: width 0.1s ease-linear; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { max-height: 85vh; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; display: inline-block; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Dodane style dla responsywności na małych ekranach */
        @media (max-width: 640px) {
            .responsive-table {
                display: block;
                width: 100%;
                overflow-x: auto;
            }
            .input-group {
                flex-direction: column;
            }
            .input-group > * {
                margin-bottom: 0.5rem;
            }
        }
        
        /* Dodane style dla wykresów */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        /* Style dla PDF */
        @media print {
            body {
                background-color: white;
                color: black;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg">

        <div class="flex justify-center mb-4">
             <img id="companyLogo" src="https://zapodaj.net/images/e6dd3fae4484c.png" alt="Logo SpacePlant" class="h-16" />
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Kalkulator Mieszanki NPK</h1>
        <div class="text-center mb-6">
            <button id="showFertilizersBtn" type="button" class="text-sm text-indigo-600 hover:text-indigo-800 underline focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded">
                Pokaż dostępne nawozy i ich skład
            </button>
        </div>


        <div class="space-y-8">
            <div class="space-y-3">
                 <label class="block text-base font-semibold text-gray-800">Masa mieszanki (kg)</label>
                 <div class="flex flex-wrap gap-3 items-center">
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="25" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>25</span></label>
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="50" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>50</span></label>
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="75" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>75</span></label>
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="100" checked class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>100</span></label>
                     <div class="flex-grow min-w-[130px] w-full sm:w-auto"><label for="customMass" class="sr-only">Inna masa</label><input type="number" id="customMass" placeholder="Inna masa" step="0.1" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                 </div>
            </div>
            <div class="space-y-3">
                 <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Docelowy Skład (%)</h3>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                     <div><label for="targetN" class="block text-sm font-medium text-gray-600 mb-1">Azot (N)</label><input type="number" id="targetN" step="0.1" min="0" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                     <div><label for="targetP" class="block text-sm font-medium text-gray-600 mb-1">Fosfor (P₂O₅)</label><input type="number" id="targetP" step="0.1" min="0" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                     <div><label for="targetK" class="block text-sm font-medium text-gray-600 mb-1">Potas (K₂O)</label><input type="number" id="targetK" step="0.1" min="0" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                     <div class="pt-2"> 
                        <label class="flex items-center mt-4">
                            <input type="checkbox" id="useMg" class="form-checkbox text-indigo-600 h-4 w-4 mr-2 rounded focus:ring-indigo-500">
                            <span class="text-sm font-medium text-gray-600">Uwzględnij Magnez (Mg)</span>
                        </label>
                        <input type="number" id="targetMg" step="0.1" min="0" max="10" value="2" disabled class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm disabled:bg-gray-100 disabled:cursor-not-allowed">
                     </div>
                 </div>
            </div>
            
            <!-- Dodane opcje optymalizacji -->
            <div class="space-y-3">
                <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Opcje Optymalizacji</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Strategia Optymalizacji</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="optimizationStrategy" value="accuracy" checked class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500">
                                <span class="text-sm text-gray-700">Dokładność (priorytet dokładnego składu)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="optimizationStrategy" value="cost" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500">
                                <span class="text-sm text-gray-700">Koszt (priorytet niższej ceny)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="toleranceSlider" class="block text-sm font-medium text-gray-600 mb-2">Tolerancja (±%)</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="toleranceSlider" min="0.5" max="5" step="0.5" value="1.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="toleranceValue" class="text-sm font-medium text-gray-700 min-w-[40px] text-right">1.5%</span>
                        </div>
                    </div>
                </div>
            </div>

            <button id="calculateButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed text-base">
                Oblicz Mieszankę NPK
            </button>

            <div id="loaderContainer" class="hidden text-center pt-4">
                 <div id="loadingText" class="text-gray-600 italic mb-3 h-5"></div>
                 <div id="progressBar" class="w-full max-w-md mx-auto bg-gray-200 rounded-full h-2.5 overflow-hidden mb-1">
                    <div id="progressBarFill" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                 </div>
                 <div id="progressPercent" class="text-sm font-medium text-indigo-700">0%</div>
            </div>

            <div id="result" class="mt-8 space-y-6 border-t border-gray-200 pt-6 hidden">
                <div id="statusMessageContainer"></div>
                
                <!-- Dodane kontenery na wykresy -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Skład Mieszanki</h3>
                        <div class="chart-container">
                            <canvas id="fertilizerChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Porównanie Składników</h3>
                        <div class="chart-container">
                            <canvas id="nutrientComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="resultTableContainer" class="overflow-x-auto responsive-table"></div>
                <div id="costInfoContainer" class="responsive-table"></div>
                <div id="finalCompContainer" class="responsive-table"></div>
                
                <!-- Przyciski eksportu -->
                <div class="flex flex-wrap justify-center gap-4 mt-6">
                    <button id="exportPdfBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        Eksportuj do PDF
                    </button>
                    <button id="printResultsBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Drukuj Wyniki
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-12 text-center text-xs text-gray-500 border-t border-gray-200 pt-4">
            <p>&copy; <span id="currentYear"></span> Space Plant Marceli Dubczyk. Wszelkie prawa zastrzeżone.</p>
        </div>
    </div>

    <!-- Modal z nawozami -->
    <div id="fertilizerModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50 modal-overlay p-4" aria-labelledby="modal-title" role="dialog" aria-modal="true">
       <div class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-lg bg-white modal-content">
           <div class="mt-3">
               <div class="flex justify-between items-center mb-4">
                   <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Dostępne Nawozy i Ich Skład</h3>
                   <button id="closeFertilizerModalBtnX" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                       <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                       <span class="sr-only">Zamknij modal</span>
                   </button>
               </div>
               <div id="fertilizerTableContainer" class="overflow-auto max-h-[60vh] border rounded-md responsive-table"></div>
               <div class="items-center px-1 py-3 mt-4">
                   <button id="closeFertilizerModalBtn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1">
                       Zamknij
                   </button>
               </div>
           </div>
       </div>
    </div>

    <!-- Modal z informacją o błędzie -->
    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50 modal-overlay p-4" aria-labelledby="error-modal-title" role="dialog" aria-modal="true">
       <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white modal-content">
           <div class="mt-3">
               <div class="flex justify-between items-center mb-4">
                   <h3 id="error-modal-title" class="text-lg leading-6 font-medium text-red-600">Błąd</h3>
                   <button id="closeErrorModalBtn" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                       <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                       <span class="sr-only">Zamknij modal</span>
                   </button>
               </div>
               <div id="errorModalContent" class="text-center py-4 text-red-600"></div>
               <div class="items-center px-1 py-3 mt-4">
                   <button id="confirmErrorModalBtn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1">
                       Rozumiem
                   </button>
               </div>
           </div>
       </div>
    </div>

    <!-- Modal z informacją o generowaniu PDF -->
    <div id="pdfGeneratingModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50 modal-overlay p-4" aria-labelledby="pdf-modal-title" role="dialog" aria-modal="true">
       <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white modal-content text-center">
           <h3 id="pdf-modal-title" class="text-lg leading-6 font-medium text-gray-900 mb-4">Generowanie PDF</h3>
           <div class="spinner"></div>
           <p class="mt-4 text-gray-600">Trwa generowanie dokumentu PDF, proszę czekać...</p>
       </div>
    </div>

    <script>
        // --- Configuration ---
        const FERTILIZER_DATA = {
            "Siarczan amonu": { N: 21, P: 0, K: 0, S: 24, Mg: 0 },
            "Saletra amonowa": { N: 34, P: 0, K: 0, S: 0, Mg: 0 },
            "Saletra potasowa": { N: 13, P: 0, K: 46, S: 0, Mg: 0 },
            "MAP (Fosforan Monoamonowy)": { N: 11, P: 61, K: 0, S: 0, Mg: 0 },
            "MKP (Fosforan Monopotasowy)": { N: 0, P: 52, K: 34, S: 0, Mg: 0 },
            "Siarczan potasu": { N: 0, P: 0, K: 50, S: 18, Mg: 0 },
            "Siarczan magnezu": { N: 0, P: 0, K: 0, S: 13, Mg: 16 }
        };
        
        const FERTILIZER_PRICES = {
            "Siarczan amonu": 45,
            "Saletra amonowa": 55,
            "Saletra potasowa": 110,
            "MAP (Fosforan Monoamonowy)": 180,
            "MKP (Fosforan Monopotasowy)": 185,
            "Siarczan potasu": 90,
            "Siarczan magnezu": 34
        };
        
        const FERTILIZER_NAMES = Object.keys(FERTILIZER_DATA);
        const NUM_FERTILIZERS = FERTILIZER_NAMES.length;
        const MG_FERT_NAME = "Siarczan magnezu";
        
        // Kolory dla wykresów
        const CHART_COLORS = [
            '#4F46E5', // indigo-600
            '#7C3AED', // purple-600
            '#EC4899', // pink-600
            '#F59E0B', // amber-500
            '#10B981', // emerald-500
            '#3B82F6', // blue-500
            '#6366F1'  // indigo-500
        ];

        // --- Zabawne komunikaty ładowania ---
        const loadingMessages = [
            "🧪 Mieszamy fotony z azotem...",
            "⚛️ Kwantyfikowanie potasu...",
            "🤖 Kalibracja cyber-łopaty...",
            "💧 Dodawanie kwantowej wody...",
            "😂 Pytanie roślin o zdanie...",
            "💡 Prawie gotowe, tylko kawa!",
            "🧬 Optymalizacja DNA nawozu...",
            "🤔 Jeszcze chwila, liczymy atomy...",
            "🚀 Przygotowanie do nawożenia!",
            "✨ Posypywanie magicznym pyłem...",
            "⏳ Cierpliwości, dobre rzeczy wymagają czasu (i obliczeń)...",
            "∑ Sumowanie jonów...",
            "％ Obliczanie stężeń procentowych..."
        ];

        // --- DOM Elements ---
        const customMassInput = document.getElementById('customMass');
        const massRadios = document.querySelectorAll('input[name="mass"]');
        const targetNInput = document.getElementById('targetN');
        const targetPInput = document.getElementById('targetP');
        const targetKInput = document.getElementById('targetK');
        const useMgCheckbox = document.getElementById('useMg');
        const targetMgInput = document.getElementById('targetMg');
        const calculateButton = document.getElementById('calculateButton');
        const loaderContainer = document.getElementById('loaderContainer');
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressPercent = document.getElementById('progressPercent');
        const resultDiv = document.getElementById('result');
        const statusMessageContainer = document.getElementById('statusMessageContainer');
        const resultTableContainer = document.getElementById('resultTableContainer');
        const costInfoContainer = document.getElementById('costInfoContainer');
        const finalCompContainer = document.getElementById('finalCompContainer');
        const showFertilizersBtn = document.getElementById('showFertilizersBtn');
        const fertilizerModal = document.getElementById('fertilizerModal');
        const closeFertilizerModalBtn = document.getElementById('closeFertilizerModalBtn');
        const closeFertilizerModalBtnX = document.getElementById('closeFertilizerModalBtnX');
        const fertilizerTableContainer = document.getElementById('fertilizerTableContainer');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const printResultsBtn = document.getElementById('printResultsBtn');
        const errorModal = document.getElementById('errorModal');
        const errorModalContent = document.getElementById('errorModalContent');
        const closeErrorModalBtn = document.getElementById('closeErrorModalBtn');
        const confirmErrorModalBtn = document.getElementById('confirmErrorModalBtn');
        const pdfGeneratingModal = document.getElementById('pdfGeneratingModal');
        const toleranceSlider = document.getElementById('toleranceSlider');
        const toleranceValue = document.getElementById('toleranceValue');
        const optimizationStrategyRadios = document.querySelectorAll('input[name="optimizationStrategy"]');

        // Wykresy
        let fertilizerChart = null;
        let nutrientComparisonChart = null;

        let lastResults = null;
        let progressInterval = null;

        // --- Global Helper Functions ---
        const checkTolerance = (nutrientsResult, targetInputs, toleranceValues) => {
            const dN = Math.abs(nutrientsResult.N - targetInputs.targetN);
            const dP = Math.abs(nutrientsResult.P - targetInputs.targetP);
            const dK = Math.abs(nutrientsResult.K - targetInputs.targetK);
            const dMg = targetInputs.useMg ? Math.abs(nutrientsResult.Mg - targetInputs.targetMg) : 0;
            
            return dN <= toleranceValues.N && 
                   dP <= toleranceValues.P && 
                   dK <= toleranceValues.K && 
                   (!targetInputs.useMg || dMg <= toleranceValues.Mg);
        };
        
        const evaluateCombination = (percentagesDecimal, currentTotalMass, targetInputs, optimizationGoal) => {
            let cN = 0, cP = 0, cK = 0, cS = 0, cMg = 0, cCost = 0;
            
            for (let i = 0; i < NUM_FERTILIZERS; i++) {
                const pDecimal = percentagesDecimal[i];
                if (pDecimal < 0.00001) continue;
                
                const aK = pDecimal * currentTotalMass;
                const name = FERTILIZER_NAMES[i];
                const n = FERTILIZER_DATA[name];
                const price = FERTILIZER_PRICES[name] || 0;
                
                cN += pDecimal * n.N;
                cP += pDecimal * n.P;
                cK += pDecimal * n.K;
                cS += pDecimal * n.S;
                cMg += pDecimal * n.Mg;
                cCost += (aK / 25) * price;
            }
            
            const nR = { N: cN, P: cP, K: cK, S: cS, Mg: cMg };
            
            // Obliczanie błędu kwadratowego
            const eN = Math.pow(targetInputs.targetN - cN, 2);
            const eP = Math.pow(targetInputs.targetP - cP, 2);
            const eK = Math.pow(targetInputs.targetK - cK, 2);
            const eMg = targetInputs.useMg ? Math.pow(targetInputs.targetMg - cMg, 2) : 0;
            
            // Waga błędu - NPK ma większą wagę niż Mg
            let errorScore = (eN + eP + eK) * 3 + eMg;
            
            // Jeśli optymalizujemy pod kątem kosztu, dodajemy koszt do wyniku błędu
            if (optimizationGoal === 'cost') {
                // Normalizacja kosztu do skali błędu
                const costFactor = 0.1; // Współczynnik wagi kosztu
                errorScore = errorScore + (cCost * costFactor);
            }
            
            return { nutrients: nR, cost: cCost, errorScore: errorScore };
        };

        // --- Walidacja danych wejściowych ---
        const validateInputs = (inputs) => {
            const { targetN, targetP, targetK, targetMg, totalMass, useMg } = inputs;
            const errors = [];
            
            if (totalMass <= 0) {
                errors.push("Masa mieszanki musi być większa od zera.");
            }
            
            if (targetN < 0 || targetP < 0 || targetK < 0) {
                errors.push("Wartości N, P, K muszą być nieujemne.");
            }
            
            if (useMg && targetMg < 0) {
                errors.push("Wartość Mg musi być nieujemna.");
            }
            
            // Sprawdzenie czy suma NPK nie przekracza 100%
            const totalNPK = targetN + targetP + targetK + (useMg ? targetMg : 0);
            if (totalNPK > 100) {
                errors.push(`Suma składników (${totalNPK.toFixed(1)}%) przekracza 100%.`);
            }
            
            return errors;
        };

        // --- Application Logic ---
        useMgCheckbox.addEventListener('change', function () {
            targetMgInput.disabled = !this.checked;
            if (!this.checked) {
                targetMgInput.value = '';
            } else {
                targetMgInput.value = targetMgInput.value || '2';
            }
        });
        
        calculateButton.addEventListener('click', handleCalculation);
        exportPdfBtn.addEventListener('click', handlePdfExport);
        printResultsBtn.addEventListener('click', handlePrint);
        
        // Obsługa suwaka tolerancji
        toleranceSlider.addEventListener('input', function() {
            toleranceValue.textContent = `${this.value}%`;
        });

        // --- Fertilizer Preview Modal Logic ---
        showFertilizersBtn.addEventListener('click', () => {
            generateFertilizerTable();
            fertilizerModal.classList.remove('hidden');
        });
        
        closeFertilizerModalBtn.addEventListener('click', () => {
            fertilizerModal.classList.add('hidden');
        });
        
        closeFertilizerModalBtnX.addEventListener('click', () => {
            fertilizerModal.classList.add('hidden');
        });
        
        fertilizerModal.addEventListener('click', (event) => {
            if (event.target === fertilizerModal) {
                fertilizerModal.classList.add('hidden');
            }
        });
        
        // Error Modal Logic
        closeErrorModalBtn.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });
        
        confirmErrorModalBtn.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });
        
        errorModal.addEventListener('click', (event) => {
            if (event.target === errorModal) {
                errorModal.classList.add('hidden');
            }
        });

        function generateFertilizerTable() {
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nazwa Nawozu</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">N (%)</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">P₂O₅ (%)</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">K₂O (%)</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">S (%)</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Mg (%)</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cena/25kg</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
            
            FERTILIZER_NAMES.forEach(name => {
                const data = FERTILIZER_DATA[name];
                const price = FERTILIZER_PRICES[name] || 0;
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.N}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.P}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.K}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.S}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.Mg}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${price.toFixed(2)} zł</td>
                    </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            fertilizerTableContainer.innerHTML = tableHTML;
        }

        // --- Synchronization Logic for Mass Input ---
        customMassInput.addEventListener('input', () => {
            const customValue = parseFloat(customMassInput.value);
            if (!isNaN(customValue) && customValue > 0) {
                massRadios.forEach(radio => {
                    radio.checked = false;
                });
            }
        });
        
        massRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.checked) {
                    customMassInput.value = '';
                }
            });
        });

        function getInputs() {
            const targetN = parseFloat(targetNInput.value) || 0;
            const targetP = parseFloat(targetPInput.value) || 0;
            const targetK = parseFloat(targetKInput.value) || 0;
            const useMg = useMgCheckbox.checked;
            const targetMg = useMg ? (parseFloat(targetMgInput.value) || 0) : null;
            
            let totalMass = 0;
            const customMass = parseFloat(customMassInput.value);
            
            if (!isNaN(customMass) && customMass > 0) {
                totalMass = customMass;
                massRadios.forEach(radio => {
                    if(radio.checked) radio.checked = false;
                });
            } else {
                customMassInput.value = '';
                for (const radio of massRadios) {
                    if (radio.checked) {
                        totalMass = parseFloat(radio.value);
                        break;
                    }
                }
                
                if (totalMass === 0) {
                    const defaultRadio = document.querySelector('input[name="mass"][value="100"]');
                    if (defaultRadio && !defaultRadio.checked) {
                        defaultRadio.checked = true;
                    }
                    totalMass = 100;
                }
            }
            
            // Pobierz strategię optymalizacji
            let optimizationGoal = 'accuracy';
            for (const radio of optimizationStrategyRadios) {
                if (radio.checked) {
                    optimizationGoal = radio.value;
                    break;
                }
            }
            
            // Pobierz wartość tolerancji
            const userTolerance = parseFloat(toleranceSlider.value);
            
            return {
                targetN,
                targetP,
                targetK,
                targetMg,
                totalMass,
                useMg,
                optimizationGoal,
                userTolerance,
                isValid: true // Walidacja będzie przeprowadzona osobno
            };
        }

        // --- Calculation Trigger with Progress Bar ---
        function handleCalculation() {
            const inputs = getInputs();
            const validationErrors = validateInputs(inputs);
            
            if (validationErrors.length > 0) {
                showErrorModal(validationErrors.join('<br>'));
                return;
            }

            calculateButton.disabled = true;
            resultDiv.style.display = 'none';
            statusMessageContainer.innerHTML = '';
            resultTableContainer.innerHTML = '';
            costInfoContainer.innerHTML = '';
            finalCompContainer.innerHTML = '';
            lastResults = null;
            loaderContainer.style.display = 'block';

            // Zniszcz istniejące wykresy, jeśli istnieją
            if (fertilizerChart) {
                fertilizerChart.destroy();
                fertilizerChart = null;
            }
            if (nutrientComparisonChart) {
                nutrientComparisonChart.destroy();
                nutrientComparisonChart = null;
            }

            let progress = 0;
            progressBarFill.style.width = '0%';
            progressPercent.textContent = '0%';
            loadingText.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            const totalDuration = 2500; // Skrócony czas ładowania
            const intervalTime = 100;
            const steps = totalDuration / intervalTime;
            const increment = 100 / steps;

            progressInterval = setInterval(() => {
                progress += increment;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    progressInterval = null;
                    progressBarFill.style.width = `${progress}%`;
                    progressPercent.textContent = `${Math.round(progress)}%`;
                    loadingText.textContent = "✅ Gotowe!";

                    setTimeout(() => {
                        try {
                            const resultData = calculateMixtureLP(inputs);
                            if (!resultData || !resultData.success) {
                                showErrorModal(resultData.message || "Nie udało się znaleźć optymalnego rozwiązania.");
                            } else {
                                lastResults = resultData.solution;
                                displayResults(resultData.solution, inputs);
                            }
                        } catch (error) {
                            console.error("Calculation error after progress:", error);
                            showErrorModal(`Wystąpił błąd podczas obliczeń: ${error.message}`);
                        } finally {
                            loaderContainer.style.display = 'none';
                            calculateButton.disabled = false;
                        }
                    }, 150);

                } else {
                    progressBarFill.style.width = `${progress}%`;
                    progressPercent.textContent = `${Math.round(progress)}%`;
                    if (Math.round(progress) % 10 === 0 || progress < increment * 2) {
                        loadingText.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
                    }
                }
            }, intervalTime);
        }

        // --- LP Solver Calculation Function ---
        function calculateMixtureLP(inputs) {
            try {
                const { targetN, targetP, targetK, targetMg, totalMass, useMg, optimizationGoal, userTolerance } = inputs;
                const numFertilizers = FERTILIZER_NAMES.length;
                
                // Ustawienie tolerancji na podstawie wartości z suwaka
                const tolerances = {
                    N: userTolerance,
                    P: userTolerance,
                    K: userTolerance,
                    Mg: userTolerance / 3 // Mniejsza tolerancja dla magnezu
                };
                
                // Sprawdzenie czy solver jest dostępny
                if (typeof solver === 'undefined' || typeof solver.Solve !== 'function') {
                    throw new Error("Biblioteka jsLPSolver nie została załadowana poprawnie.");
                }
                
                // Tworzenie modelu LP
                const model = {
                    optimize: "errorScore",
                    opType: "min",
                    constraints: {},
                    variables: {},
                    ints: {}
                };
                
                const nutrientKeys = useMg ? ['N', 'P', 'K', 'Mg'] : ['N', 'P', 'K'];
                
                // Definiowanie zmiennych dla każdego nawozu
                FERTILIZER_NAMES.forEach((name, i) => {
                    model.variables[`f${i}`] = {
                        [`sumConstraint`]: 1,
                        errorScore: 0
                    };
                    
                    // Dodanie współczynników dla każdego składnika odżywczego
                    nutrientKeys.forEach(nutKey => {
                        const dataKey = nutKey === 'P' ? 'P' : (nutKey === 'K' ? 'K' : nutKey);
                        model.variables[`f${i}`][`${nutKey}Target`] = FERTILIZER_DATA[name][dataKey] / 100;
                    });
                    
                    // Jeśli optymalizujemy pod kątem kosztu, dodajemy koszt do funkcji celu
                    if (optimizationGoal === 'cost') {
                        const price = FERTILIZER_PRICES[name] || 0;
                        model.variables[`f${i}`].errorScore = price / 100; // Normalizacja ceny
                    }
                });
                
                // Dodanie zmiennej błędu
                model.variables.errorScore = { errorScore: 1 };
                
                // Dodanie zmiennych odchylenia dla każdego składnika odżywczego
                nutrientKeys.forEach(nutKey => {
                    model.variables[`${nutKey}DevPos`] = { errorScore: 1, [`${nutKey}Target`]: -1 };
                    model.variables[`${nutKey}DevNeg`] = { errorScore: 1, [`${nutKey}Target`]: 1 };
                });
                
                // Ograniczenia
                model.constraints[`sumConstraint`] = { equal: 1 };
                
                // Ograniczenia dla każdego składnika odżywczego
                nutrientKeys.forEach(nutKey => {
                    const targetValue = nutKey === 'N' ? targetN : 
                                       (nutKey === 'P' ? targetP : 
                                       (nutKey === 'K' ? targetK : targetMg));
                    model.constraints[`${nutKey}Target`] = { equal: targetValue / 100 };
                });
                
                // Jeśli nie uwzględniamy magnezu, wymuszamy zerową ilość siarczanu magnezu
                if (!useMg) {
                    const mgFertIndex = FERTILIZER_NAMES.indexOf(MG_FERT_NAME);
                    if (mgFertIndex !== -1) {
                        const mgVarName = `f${mgFertIndex}`;
                        if (model.variables[mgVarName]) {
                            const constraintName = `mgZeroConstraint`;
                            model.constraints[constraintName] = { equal: 0 };
                            model.variables[mgVarName][constraintName] = 1;
                            console.log(`Added constraint: ${mgVarName} = 0`);
                        }
                    }
                }
                
                console.log("LP Model:", JSON.stringify(model, null, 2));
                
                // Rozwiązanie problemu LP
                const solution = solver.Solve(model);
                console.log("LP Solution:", solution);
                
                if (!solution || !solution.feasible) {
                    return {
                        success: false,
                        message: "Nie znaleziono wykonalnego rozwiązania. Sprawdź, czy zadane wartości docelowe są możliwe do osiągnięcia."
                    };
                }
                
                // Przetwarzanie wyników
                const finalPercentages = new Array(numFertilizers).fill(0);
                let calculatedSum = 0;
                
                for (let i = 0; i < numFertilizers; i++) {
                    finalPercentages[i] = (solution[`f${i}`] || 0) * 100;
                    calculatedSum += finalPercentages[i];
                }
                
                // Normalizacja sumy do 100%
                if (Math.abs(calculatedSum - 100) > 0.1) {
                    console.warn(`Sum normalization needed: ${calculatedSum}`);
                    if (calculatedSum > 0) {
                        const scale = 100 / calculatedSum;
                        for (let i = 0; i < numFertilizers; i++) {
                            finalPercentages[i] *= scale;
                        }
                    }
                }
                
                // Upewnienie się, że wszystkie wartości są nieujemne
                for (let i = 0; i < numFertilizers; i++) {
                    finalPercentages[i] = Math.max(0, finalPercentages[i]);
                }
                
                // Obliczenie końcowych wartości
                const finalEval = evaluateCombination(finalPercentages.map(p => p / 100), totalMass, inputs, optimizationGoal);
                
                const finalBestCombination = {
                    percentages: finalPercentages,
                    nutrients: finalEval.nutrients,
                    cost: finalEval.cost,
                    score: finalEval.errorScore,
                    optimizationGoal: optimizationGoal
                };
                
                return {
                    success: true,
                    solution: {
                        bestCombination: finalBestCombination,
                        tolerances: tolerances
                    }
                };
            } catch (error) {
                console.error("Error in calculateMixtureLP:", error);
                return {
                    success: false,
                    message: `Błąd podczas obliczeń: ${error.message}`
                };
            }
        }

        // --- Funkcje wyświetlania wyników ---
        function showErrorModal(message) {
            errorModalContent.innerHTML = message;
            errorModal.classList.remove('hidden');
            loaderContainer.style.display = 'none';
            calculateButton.disabled = false;
        }
        
        function displayResults(resultsData, inputs) {
            const { bestCombination, tolerances } = resultsData;
            const { totalMass, useMg } = inputs;
            
            if (!bestCombination) {
                showErrorModal("Wystąpił nieoczekiwany błąd - brak wyników.");
                return;
            }
            
            const { percentages, nutrients, cost, optimizationGoal } = bestCombination;
            const { N: rN, P: rP, K: rK, Mg: rMg, S: rS } = nutrients;
            const { targetN, targetP, targetK, targetMg } = inputs;
            
            const isWithinTolerance = checkTolerance(nutrients, inputs, tolerances);
            
            let statusMessage = "";
            let statusClass = "";
            
            if (isWithinTolerance) {
                statusMessage = `✅ Sukces! Znaleziono optymalną mieszankę NPK w zadanych granicach tolerancji (±${tolerances.N.toFixed(1)}%).`;
                statusClass = "bg-green-100 border-green-400 text-green-700";
            } else {
                statusMessage = `⚠️ Uwaga: Optymalna znaleziona mieszanka NPK nadal odbiega od celu poza zakresem tolerancji (±${tolerances.N.toFixed(1)}%). Sprawdź szczegóły poniżej.`;
                statusClass = "bg-yellow-100 border-yellow-400 text-yellow-700";
            }
            
            // Dodanie informacji o strategii optymalizacji
            const strategyInfo = optimizationGoal === 'cost' 
                ? "Zastosowano optymalizację pod kątem kosztu." 
                : "Zastosowano optymalizację pod kątem dokładności składu.";
            
            statusMessageContainer.innerHTML = `
                <div class="${statusClass} border px-4 py-3 rounded-lg relative" role="alert">
                    <p class="font-medium">${statusMessage}</p>
                    <p class="mt-1 text-sm">${strategyInfo}</p>
                </div>`;
            
            resultTableContainer.innerHTML = generateCompositionTable(percentages, totalMass);
            costInfoContainer.innerHTML = generateCostTable(percentages, totalMass, cost);
            finalCompContainer.innerHTML = generateNutrientResultTable(inputs, nutrients, tolerances);
            
            // Generowanie wykresów
            renderFertilizerChart(percentages);
            renderNutrientComparisonChart(inputs, nutrients);
            
            resultDiv.style.display = 'block';
            loaderContainer.style.display = 'none';
            
            // Przewinięcie do wyników
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function generateCompositionTable(percentages, totalMass) {
            let html = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Składniki Mieszanki NPK:</h3>
                <div class="overflow-x-auto mb-6 shadow-sm rounded-lg border border-gray-200">
                    <table class="min-w-full bg-white text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 border-b text-left font-semibold text-gray-600">Nawóz</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">%</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Ilość [kg]</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">`;
            
            let totalCalculatedMass = 0;
            let actualSumPercentage = 0;
            
            FERTILIZER_NAMES.forEach((name, i) => {
                const percentage = percentages[i];
                if (percentage > 0.01) {
                    const actualKg = (percentage / 100) * totalMass;
                    totalCalculatedMass += actualKg;
                    actualSumPercentage += percentage;
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2">${name}</td>
                            <td class="px-4 py-2 text-right">${percentage.toFixed(1)}</td>
                            <td class="px-4 py-2 text-right">${actualKg.toFixed(2)}</td>
                        </tr>`;
                }
            });
            
            html += `
                <tr class="bg-gray-100 font-semibold">
                    <td class="px-4 py-2 text-left" colspan="1">Suma:</td>
                    <td class="px-4 py-2 text-right">${actualSumPercentage.toFixed(1)}</td>
                    <td class="px-4 py-2 text-right">${totalCalculatedMass.toFixed(2)}</td>
                </tr>
            </tbody></table></div>`;
            
            return html;
        }
        
        function generateCostTable(percentages, totalMass, totalCost) {
            let html = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Szacowany Koszt Mieszanki NPK:</h3>
                <div class="overflow-x-auto mb-6 shadow-sm rounded-lg border border-gray-200">
                    <table class="min-w-full bg-white text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 border-b text-left font-semibold text-gray-600">Nawóz</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Ilość [kg]</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Cena/25kg [zł]</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Koszt [zł]</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">`;
            
            FERTILIZER_NAMES.forEach((name, i) => {
                const percentage = percentages[i];
                if (percentage > 0.01) {
                    const actualKg = (percentage / 100) * totalMass;
                    const price25kg = FERTILIZER_PRICES[name] || 0;
                    const cost = (actualKg / 25) * price25kg;
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2">${name}</td>
                            <td class="px-4 py-2 text-right">${actualKg.toFixed(2)}</td>
                            <td class="px-4 py-2 text-right">${price25kg.toFixed(2)}</td>
                            <td class="px-4 py-2 text-right">${cost.toFixed(2)}</td>
                        </tr>`;
                }
            });
            
            html += `
                <tr class="bg-indigo-50 font-bold">
                    <td class="px-4 py-2 text-left text-indigo-800" colspan="3">Całkowity koszt (${totalMass.toFixed(1)} kg):</td>
                    <td class="px-4 py-2 text-right text-indigo-800">${totalCost.toFixed(2)} zł</td>
                </tr>
                <tr class="bg-indigo-50 font-semibold">
                    <td class="px-4 py-2 text-left text-indigo-800" colspan="3">Koszt za 1 kg:</td>
                    <td class="px-4 py-2 text-right text-indigo-800">${(totalCost / totalMass).toFixed(2)} zł</td>
                </tr>
            </tbody></table></div>`;
            
            return html;
        }
        
        function generateNutrientResultTable(inputs, nutrients, tolerances) {
            const { targetN, targetP, targetK, targetMg, useMg } = inputs;
            const { N: rN, P: rP, K: rK, Mg: rMg, S: rS } = nutrients;
            
            let html = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Wynikowa Mieszanka NPK:</h3>
                <div class="overflow-x-auto shadow-sm rounded-lg border border-gray-200">
                    <table class="min-w-full bg-white text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 border-b text-left font-semibold text-gray-600">Składnik</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Docelowo [%]</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Uzyskano [%]</th>
                                <th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Różnica [%]</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">`;
            
            const formatNutrientRow = (name, target, result, tolerance) => {
                if (target === null || target === undefined) return '';
                
                const difference = result - target;
                let differenceClass = 'text-gray-700';
                
                if (Math.abs(difference) > tolerance) {
                    differenceClass = 'text-red-600 font-bold';
                } else if (Math.abs(difference) > 0.01) {
                    differenceClass = 'text-yellow-600';
                }
                
                const tooltipHtml = `
                    <span class="tooltip info-icon">? 
                        <span class="tooltiptext">Tolerancja: ±${tolerance.toFixed(2)}%</span>
                    </span>`;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">${name}</td>
                        <td class="px-4 py-2 text-right">${target.toFixed(2)}</td>
                        <td class="px-4 py-2 text-right font-semibold text-gray-900">${result.toFixed(2)} ${tooltipHtml}</td>
                        <td class="px-4 py-2 text-right ${differenceClass}">${difference.toFixed(2)}</td>
                    </tr>`;
            };
            
            html += formatNutrientRow('Azot (N)', targetN, rN, tolerances.N);
            html += formatNutrientRow('Fosfor (P₂O₅)', targetP, rP, tolerances.P);
            html += formatNutrientRow('Potas (K₂O)', targetK, rK, tolerances.K);
            
            if (useMg) {
                html += formatNutrientRow('Magnez (Mg)', targetMg, rMg, tolerances.Mg);
            }
            
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">Siarka (S)</td>
                    <td class="px-4 py-2 text-right">-</td>
                    <td class="px-4 py-2 text-right font-semibold">${rS.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right">-</td>
                </tr>
            </tbody></table></div>`;
            
            return html;
        }
        
        // --- Funkcje generowania wykresów ---
        function renderFertilizerChart(percentages) {
            const ctx = document.getElementById('fertilizerChart').getContext('2d');
            
            // Filtrowanie nawozów z niezerowymi wartościami
            const labels = [];
            const data = [];
            const backgroundColors = [];
            
            FERTILIZER_NAMES.forEach((name, i) => {
                if (percentages[i] > 0.01) {
                    labels.push(name);
                    data.push(percentages[i]);
                    backgroundColors.push(CHART_COLORS[i % CHART_COLORS.length]);
                }
            });
            
            fertilizerChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw.toFixed(1);
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderNutrientComparisonChart(inputs, nutrients) {
            const ctx = document.getElementById('nutrientComparisonChart').getContext('2d');
            
            const { targetN, targetP, targetK, targetMg, useMg } = inputs;
            const { N: rN, P: rP, K: rK, Mg: rMg } = nutrients;
            
            const labels = ['Azot (N)', 'Fosfor (P₂O₅)', 'Potas (K₂O)'];
            const targetData = [targetN, targetP, targetK];
            const actualData = [rN, rP, rK];
            
            if (useMg) {
                labels.push('Magnez (Mg)');
                targetData.push(targetMg);
                actualData.push(rMg);
            }
            
            nutrientComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Docelowo',
                            data: targetData,
                            backgroundColor: 'rgba(79, 70, 229, 0.6)', // indigo-600 z przezroczystością
                            borderColor: 'rgb(79, 70, 229)',
                            borderWidth: 1
                        },
                        {
                            label: 'Uzyskano',
                            data: actualData,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)', // emerald-500 z przezroczystością
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Zawartość [%]'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw.toFixed(2);
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Funkcja eksportu do PDF ---
        function handlePdfExport() {
            if (!lastResults) {
                showErrorModal("Brak wyników do eksportu. Najpierw oblicz mieszankę NPK.");
                return;
            }
            
            // Pokaż modal z informacją o generowaniu PDF
            pdfGeneratingModal.classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    
                    // Utwórz nowy dokument PDF
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Dodaj nagłówek
                    doc.setFontSize(18);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Raport Mieszanki NPK', 105, 20, { align: 'center' });
                    
                    // Dodaj datę
                    doc.setFontSize(10);
                    doc.text(`Data wygenerowania: ${new Date().toLocaleString('pl-PL')}`, 105, 30, { align: 'center' });
                    
                    // Przygotuj dane do wydruku
                    const inputs = getInputs();
                    const { bestCombination, tolerances } = lastResults;
                    const { percentages, nutrients, cost } = bestCombination;
                    
                    // Dodaj informacje o parametrach
                    doc.setFontSize(12);
                    doc.text('Parametry wejściowe:', 20, 45);
                    doc.setFontSize(10);
                    doc.text(`Masa mieszanki: ${inputs.totalMass} kg`, 25, 55);
                    doc.text(`Docelowy skład: N: ${inputs.targetN}%, P₂O₅: ${inputs.targetP}%, K₂O: ${inputs.targetK}%${inputs.useMg ? `, Mg: ${inputs.targetMg}%` : ''}`, 25, 60);
                    doc.text(`Strategia optymalizacji: ${inputs.optimizationGoal === 'cost' ? 'Koszt' : 'Dokładność'}`, 25, 65);
                    doc.text(`Tolerancja: ±${inputs.userTolerance}%`, 25, 70);
                    
                    // Dodaj tabelę składników
                    doc.setFontSize(12);
                    doc.text('Składniki Mieszanki NPK:', 20, 85);
                    
                    let yPos = 95;
                    doc.setFontSize(9);
                    doc.text('Nawóz', 25, yPos);
                    doc.text('%', 120, yPos, { align: 'right' });
                    doc.text('Ilość [kg]', 170, yPos, { align: 'right' });
                    
                    yPos += 5;
                    doc.setLineWidth(0.1);
                    doc.line(20, yPos, 190, yPos);
                    
                    yPos += 7;
                    let totalCalculatedMass = 0;
                    let actualSumPercentage = 0;
                    
                    FERTILIZER_NAMES.forEach((name, i) => {
                        const percentage = percentages[i];
                        if (percentage > 0.01) {
                            const actualKg = (percentage / 100) * inputs.totalMass;
                            totalCalculatedMass += actualKg;
                            actualSumPercentage += percentage;
                            
                            doc.text(name, 25, yPos);
                            doc.text(percentage.toFixed(1), 120, yPos, { align: 'right' });
                            doc.text(actualKg.toFixed(2), 170, yPos, { align: 'right' });
                            
                            yPos += 7;
                        }
                    });
                    
                    doc.line(20, yPos, 190, yPos);
                    yPos += 7;
                    doc.setFont(undefined, 'bold');
                    doc.text('Suma:', 25, yPos);
                    doc.text(actualSumPercentage.toFixed(1), 120, yPos, { align: 'right' });
                    doc.text(totalCalculatedMass.toFixed(2), 170, yPos, { align: 'right' });
                    doc.setFont(undefined, 'normal');
                    
                    // Dodaj tabelę kosztów
                    yPos += 15;
                    doc.setFontSize(12);
                    doc.text('Szacowany Koszt Mieszanki NPK:', 20, yPos);
                    
                    yPos += 10;
                    doc.setFontSize(9);
                    doc.text('Całkowity koszt:', 25, yPos);
                    doc.text(`${cost.toFixed(2)} zł`, 170, yPos, { align: 'right' });
                    
                    yPos += 7;
                    doc.text('Koszt za 1 kg:', 25, yPos);
                    doc.text(`${(cost / inputs.totalMass).toFixed(2)} zł`, 170, yPos, { align: 'right' });
                    
                    // Dodaj tabelę wynikową
                    yPos += 15;
                    doc.setFontSize(12);
                    doc.text('Wynikowa Mieszanka NPK:', 20, yPos);
                    
                    yPos += 10;
                    doc.setFontSize(9);
                    doc.text('Składnik', 25, yPos);
                    doc.text('Docelowo [%]', 80, yPos, { align: 'right' });
                    doc.text('Uzyskano [%]', 130, yPos, { align: 'right' });
                    doc.text('Różnica [%]', 170, yPos, { align: 'right' });
                    
                    yPos += 5;
                    doc.line(20, yPos, 190, yPos);
                    
                    yPos += 7;
                    
                    // Funkcja do dodawania wiersza z danymi składnika
                    const addNutrientRow = (name, target, result, tolerance) => {
                        if (target === null || target === undefined) return;
                        
                        const difference = result - target;
                        
                        doc.text(name, 25, yPos);
                        doc.text(target.toFixed(2), 80, yPos, { align: 'right' });
                        doc.text(result.toFixed(2), 130, yPos, { align: 'right' });
                        
                        if (Math.abs(difference) > tolerance) {
                            doc.setTextColor(255, 0, 0); // Czerwony dla wartości poza tolerancją
                        } else if (Math.abs(difference) > 0.01) {
                            doc.setTextColor(255, 165, 0); // Pomarańczowy dla małych różnic
                        }
                        
                        doc.text(difference.toFixed(2), 170, yPos, { align: 'right' });
                        doc.setTextColor(0, 0, 0); // Przywrócenie czarnego koloru
                        
                        yPos += 7;
                    };
                    
                    addNutrientRow('Azot (N)', inputs.targetN, nutrients.N, tolerances.N);
                    addNutrientRow('Fosfor (P₂O₅)', inputs.targetP, nutrients.P, tolerances.P);
                    addNutrientRow('Potas (K₂O)', inputs.targetK, nutrients.K, tolerances.K);
                    
                    if (inputs.useMg) {
                        addNutrientRow('Magnez (Mg)', inputs.targetMg, nutrients.Mg, tolerances.Mg);
                    }
                    
                    doc.text('Siarka (S)', 25, yPos);
                    doc.text('-', 80, yPos, { align: 'right' });
                    doc.text(nutrients.S.toFixed(2), 130, yPos, { align: 'right' });
                    doc.text('-', 170, yPos, { align: 'right' });
                    
                    // Dodaj stopkę
                    doc.setFontSize(8);
                    doc.text(`© ${new Date().getFullYear()} Space Plant Marceli Dubczyk. Wygenerowano przez Kalkulator Mieszanki NPK v39.`, 105, 285, { align: 'center' });
                    
                    // Zapisz plik
                    doc.save('mieszanka_npk_raport.pdf');
                    
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    showErrorModal(`Błąd podczas generowania PDF: ${error.message}`);
                } finally {
                    // Ukryj modal z informacją o generowaniu PDF
                    pdfGeneratingModal.classList.add('hidden');
                }
            }, 500); // Małe opóźnienie, aby modal zdążył się pokazać
        }
        
        // --- Funkcja drukowania wyników ---
        function handlePrint() {
            if (!lastResults) {
                showErrorModal("Brak wyników do wydrukowania. Najpierw oblicz mieszankę NPK.");
                return;
            }
            
            window.print();
        }

        // --- Initialization ---
        targetMgInput.disabled = !useMgCheckbox.checked;
        
        // Ustawienie roku w stopce przy ładowaniu strony
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Dodanie obsługi klawisza Enter dla pól formularza
        [targetNInput, targetPInput, targetKInput, targetMgInput, customMassInput].forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleCalculation();
                }
            });
        });
    </script>

</body>
</html>
