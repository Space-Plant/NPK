<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator NPK v41 (Wskazówka Mg)</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/javascript-lp-solver/prod/solver.js"></script>
    <style>
        /* Style bez zmian */
        input[type="radio"]:checked + span { color: theme('colors.indigo.700'); font-weight: 600; }
        label.radio-label:has(input[type="radio"]:checked) { background-color: theme('colors.indigo.50'); border-color: theme('colors.indigo.300'); }
        .tooltip { position: relative; display: inline-block; cursor: help; vertical-align: middle; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 5px; position: absolute; z-index: 50; bottom: 135%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .info-icon { display: inline-block; width: 16px; height: 16px; background-color: #a0aec0; color: white; border-radius: 50%; text-align: center; font-size: 12px; line-height: 16px; font-weight: bold; margin-left: 4px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; display: inline-block; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { max-height: 85vh; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg">

        <div class="flex justify-center mb-4">
             <img id="companyLogo" src="https://zapodaj.net/images/e6dd3fae4484c.png" alt="Logo SpacePlant" class="h-16" />
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Kalkulator Mieszanki NPK</h1>
        <div class="text-center mb-6">
            <button id="showFertilizersBtn" type="button" class="text-sm text-indigo-600 hover:text-indigo-800 underline focus:outline-none focus:ring-2 focus:ring-indigo-400 rounded">
                Pokaż dostępne nawozy i ich skład
            </button>
        </div>

        <div class="space-y-8">
            <div class="space-y-3">
                 <label class="block text-base font-semibold text-gray-800">Masa mieszanki (kg)</label>
                 <div class="flex flex-wrap gap-3 items-center">
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="25" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>25</span></label>
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="50" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>50</span></label>
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="75" class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>75</span></label>
                     <label class="radio-label inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-150"><input type="radio" name="mass" value="100" checked class="form-radio text-indigo-600 mr-2 focus:ring-indigo-500"><span>100</span></label>
                     <div class="flex-grow min-w-[130px] w-full sm:w-auto"><label for="customMass" class="sr-only">Inna masa</label><input type="number" id="customMass" placeholder="Inna masa" step="0.1" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                 </div>
            </div>
            <div class="space-y-3">
                 <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-4">Docelowy Skład (%)</h3>
                 <div class="grid grid-cols-2 gap-x-4 gap-y-4">
                     <div><label for="targetN" class="block text-sm font-medium text-gray-600 mb-1">Azot (N)</label><input type="number" id="targetN" step="0.1" min="0" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                     <div><label for="targetP" class="block text-sm font-medium text-gray-600 mb-1">Fosfor (P₂O₅)</label><input type="number" id="targetP" step="0.1" min="0" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                     <div><label for="targetK" class="block text-sm font-medium text-gray-600 mb-1">Potas (K₂O)</label><input type="number" id="targetK" step="0.1" min="0" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"></div>
                     <div class="pt-2"> <label class="flex items-center mt-4"><input type="checkbox" id="useMg" class="form-checkbox text-indigo-600 h-4 w-4 mr-2 rounded focus:ring-indigo-500"><span class="text-sm font-medium text-gray-600">Uwzględnij Magnez (Mg)</span></label><input type="number" id="targetMg" step="0.1" min="0" max="10" value="2" disabled class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm disabled:bg-gray-100 disabled:cursor-not-allowed"></div>
                 </div>
            </div>

            <button id="calculateButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed text-base">
                Oblicz Mieszankę NPK
            </button>

            <div id="loaderContainer" class="hidden text-center pt-4">
                 <div class="spinner"></div>
                 <p class="text-sm text-gray-500 mt-2">Obliczanie...</p>
            </div>

            <div id="result" class="mt-8 space-y-6 border-t border-gray-200 pt-6 hidden">
                <div id="statusMessageContainer"></div>
                <div id="hintsContainer" class="text-sm text-gray-600"></div>
                <div id="resultTableContainer" class="overflow-x-auto"></div>
                <div id="costInfoContainer"></div>
                 <div id="finalCompContainer"></div>
            </div>
        </div>

        <div class="mt-12 text-center text-xs text-gray-500 border-t border-gray-200 pt-4">
            <p>&copy; <span id="currentYear"></span> Space Plant Marceli Dubczyk. Wszelkie prawa zastrzeżone.</p>
        </div>
        </div>

     <div id="fertilizerModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50 modal-overlay p-4" aria-labelledby="modal-title" role="dialog" aria-modal="true">
       <div class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-lg bg-white modal-content"> <div class="mt-3"> <div class="flex justify-between items-center mb-4"> <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Dostępne Nawozy i Ich Skład</h3> <button id="closeFertilizerModalBtnX" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"> <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg> <span class="sr-only">Zamknij modal</span> </button> </div><div id="fertilizerTableContainer" class="overflow-auto max-h-[60vh] border rounded-md"> </div><div class="items-center px-1 py-3 mt-4"> <button id="closeFertilizerModalBtn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"> Zamknij </button> </div></div></div></div>


    <script>
        // --- Configuration ---
        const FERTILIZER_DATA = { "Siarczan amonu": { N: 21, P: 0, K: 0, S: 24, Mg: 0 }, "Saletra amonowa": { N: 34, P: 0, K: 0, S: 0, Mg: 0 }, "Saletra potasowa": { N: 13, P: 0, K: 46, S: 0, Mg: 0 }, "MAP (Fosforan Monoamonowy)": { N: 11, P: 61, K: 0, S: 0, Mg: 0 }, "MKP (Fosforan Monopotasowy)": { N: 0, P: 52, K: 34, S: 0, Mg: 0 }, "Siarczan potasu": { N: 0, P: 0, K: 50, S: 18, Mg: 0 }, "Siarczan magnezu": { N: 0, P: 0, K: 0, S: 13, Mg: 16 } };
        const FERTILIZER_PRICES = { "Siarczan amonu": 45, "Saletra amonowa": 55, "Saletra potasowa": 110, "MAP (Fosforan Monoamonowy)": 180, "MKP (Fosforan Monopotasowy)": 185, "Siarczan potasu": 90, "Siarczan magnezu": 34 };
        const FERTILIZER_NAMES = Object.keys(FERTILIZER_DATA);
        const NUM_FERTILIZERS = FERTILIZER_NAMES.length;
        const MG_FERT_NAME = "Siarczan magnezu";
        const ABSOLUTE_TOLERANCE = { N: 1.5, P: 1.5, K: 1.5, Mg: 0.5 };

        // --- DOM Elements ---
        const customMassInput = document.getElementById('customMass'); const massRadios = document.querySelectorAll('input[name="mass"]'); const targetNInput = document.getElementById('targetN'); const targetPInput = document.getElementById('targetP'); const targetKInput = document.getElementById('targetK'); const useMgCheckbox = document.getElementById('useMg'); const targetMgInput = document.getElementById('targetMg'); const calculateButton = document.getElementById('calculateButton'); const loaderContainer = document.getElementById('loaderContainer');
        const resultDiv = document.getElementById('result'); const statusMessageContainer = document.getElementById('statusMessageContainer');
        const hintsContainer = document.getElementById('hintsContainer'); // Kontener na wskazówki
        const resultTableContainer = document.getElementById('resultTableContainer'); const costInfoContainer = document.getElementById('costInfoContainer'); const finalCompContainer = document.getElementById('finalCompContainer');
        const showFertilizersBtn = document.getElementById('showFertilizersBtn'); const fertilizerModal = document.getElementById('fertilizerModal'); const closeFertilizerModalBtn = document.getElementById('closeFertilizerModalBtn'); const closeFertilizerModalBtnX = document.getElementById('closeFertilizerModalBtnX'); const fertilizerTableContainer = document.getElementById('fertilizerTableContainer');

        let lastResults = null;

        // --- Global Helper Functions ---
        const checkTolerance = (nutrientsResult, targetInputs, toleranceValues) => { const dN = Math.abs(nutrientsResult.N - targetInputs.targetN); const dP = Math.abs(nutrientsResult.P - targetInputs.targetP); const dK = Math.abs(nutrientsResult.K - targetInputs.targetK); const dMg = targetInputs.useMg ? Math.abs(nutrientsResult.Mg - targetInputs.targetMg) : 0; return dN <= toleranceValues.N && dP <= toleranceValues.P && dK <= toleranceValues.K && (!targetInputs.useMg || dMg <= toleranceValues.Mg); };
        const evaluateCombination = (percentagesDecimal, currentTotalMass, targetInputs) => { let cN = 0, cP = 0, cK = 0, cS = 0, cMg = 0, cCost = 0; for (let i = 0; i < NUM_FERTILIZERS; i++) { const pDecimal = percentagesDecimal[i]; if (pDecimal < 0.00001) continue; const aK = pDecimal * currentTotalMass; const name = FERTILIZER_NAMES[i]; const n = FERTILIZER_DATA[name]; const price = FERTILIZER_PRICES[name] || 0; cN += pDecimal * n.N; cP += pDecimal * n.P; cK += pDecimal * n.K; cS += pDecimal * n.S; cMg += pDecimal * n.Mg; cCost += (aK / 25) * price; } const nR = { N: cN, P: cP, K: cK, S: cS, Mg: cMg }; const eN = Math.pow(targetInputs.targetN - cN, 2); const eP = Math.pow(targetInputs.targetP - cP, 2); const eK = Math.pow(targetInputs.targetK - cK, 2); const eMg = targetInputs.useMg ? Math.pow(targetInputs.targetMg - cMg, 2) : 0; const eS = (eN + eP + eK) * 3 + eMg; return { nutrients: nR, cost: cCost, errorScore: eS }; };

        // --- Application Logic ---
        useMgCheckbox.addEventListener('change', function () { targetMgInput.disabled = !this.checked; if (!this.checked) targetMgInput.value = ''; else targetMgInput.value = targetMgInput.value || '2'; });
        calculateButton.addEventListener('click', handleCalculation);

        // --- Fertilizer Preview Modal Logic ---
        showFertilizersBtn.addEventListener('click', () => { generateFertilizerTable(); fertilizerModal.classList.remove('hidden'); });
        closeFertilizerModalBtn.addEventListener('click', () => { fertilizerModal.classList.add('hidden'); });
        closeFertilizerModalBtnX.addEventListener('click', () => { fertilizerModal.classList.add('hidden'); });
        fertilizerModal.addEventListener('click', (event) => { if (event.target === fertilizerModal) { fertilizerModal.classList.add('hidden'); } });
        function generateFertilizerTable() { /* ... bez zmian ... */ let tableHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nazwa Nawozu</th><th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">N (%)</th><th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">P₂O₅ (%)</th><th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">K₂O (%)</th><th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">S (%)</th><th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Mg (%)</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`; FERTILIZER_NAMES.forEach(name => { const data = FERTILIZER_DATA[name]; tableHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.N}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.P}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.K}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.S}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${data.Mg}</td></tr>`; }); tableHTML += `</tbody></table>`; fertilizerTableContainer.innerHTML = tableHTML; }

        // --- Synchronization Logic for Mass Input ---
        customMassInput.addEventListener('input', () => { const customValue = parseFloat(customMassInput.value); if (!isNaN(customValue) && customValue > 0) { massRadios.forEach(radio => { radio.checked = false; }); } });
        massRadios.forEach(radio => { radio.addEventListener('change', () => { if (radio.checked) { customMassInput.value = ''; } }); });

        function getInputs() {
            const targetN = parseFloat(targetNInput.value) || 0; const targetP = parseFloat(targetPInput.value) || 0; const targetK = parseFloat(targetKInput.value) || 0;
            const useMg = useMgCheckbox.checked; const targetMg = useMg ? (parseFloat(targetMgInput.value) || 0) : null;
            let isValid = targetN >= 0 && targetP >= 0 && targetK >= 0 && (!useMg || targetMg >= 0);
            let totalMass = 0; const customMass = parseFloat(customMassInput.value);
            if (!isNaN(customMass) && customMass > 0) { totalMass = customMass; massRadios.forEach(radio => { if(radio.checked) radio.checked = false; }); }
            else { customMassInput.value = ''; for (const radio of massRadios) { if (radio.checked) { totalMass = parseFloat(radio.value); break; } } if (totalMass === 0) { const dr = document.querySelector('input[name="mass"][value="100"]'); if (dr && !dr.checked) { dr.checked = true; } totalMass = 100; } }
            if (totalMass <= 0) isValid = false;
            const optimizationGoal = 'accuracy'; const userTolerance = 1.5;
            return { targetN, targetP, targetK, targetMg, totalMass, useMg, optimizationGoal, userTolerance, isValid };
        }

        function handleCalculation() {
            const inputs = getInputs();
            if (!inputs.isValid) { showError("Proszę wprowadzić poprawne, nieujemne liczby dla wymaganych pól (N, P, K" + (inputs.useMg ? ", Mg" : "") + ") oraz wybrać masę."); return; }
            calculateButton.disabled = true; loaderContainer.style.display = 'block'; resultDiv.style.display = 'none'; statusMessageContainer.innerHTML = ''; resultTableContainer.innerHTML = ''; costInfoContainer.innerHTML = ''; finalCompContainer.innerHTML = ''; hintsContainer.innerHTML = '';
            lastResults = null;

            setTimeout(() => {
                try {
                    const resultData = calculateMixtureLP(inputs);
                    if (!resultData || !resultData.success) { showError(resultData.message || "Nie udało się znaleźć optymalnego rozwiązania. Sprawdź wartości docelowe lub dostępność nawozów."); }
                    else {
                        lastResults = resultData.solution;
                        displayResults(resultData.solution, inputs);
                    }
                } catch (error) { console.error("Calculation error:", error); showError(`Wystąpił błąd podczas obliczeń: ${error.message}`); }
                finally { loaderContainer.style.display = 'none'; calculateButton.disabled = false; }
            }, 50);
        }

        // --- LP Solver Calculation Function ---
        function calculateMixtureLP(inputs) {
            // (Kod funkcji calculateMixtureLP bez zmian od v26)
             const { targetN, targetP, targetK, targetMg, totalMass, useMg } = inputs; const numFertilizers = FERTILIZER_NAMES.length; const model = { optimize: "errorScore", opType: "min", constraints: {}, variables: {}, ints: {} }; const nutrientKeys = useMg ? ['N', 'P', 'K', 'Mg'] : ['N', 'P', 'K'];
            FERTILIZER_NAMES.forEach((name, i) => { model.variables[`f${i}`] = { [`sumConstraint`]: 1, errorScore: 0 }; nutrientKeys.forEach(nutKey => { const dataKey = nutKey === 'P' ? 'P' : (nutKey === 'K' ? 'K' : nutKey); model.variables[`f${i}`][`${nutKey}Target`] = FERTILIZER_DATA[name][dataKey] / 100; }); });
            model.variables.errorScore = { errorScore: 1 }; nutrientKeys.forEach(nutKey => { model.variables[`${nutKey}DevPos`] = { errorScore: 1, [`${nutKey}Target`]: -1 }; model.variables[`${nutKey}DevNeg`] = { errorScore: 1, [`${nutKey}Target`]: 1 }; });
            model.constraints[`sumConstraint`] = { equal: 1 }; nutrientKeys.forEach(nutKey => { const targetValue = nutKey === 'N' ? targetN : (nutKey === 'P' ? targetP : (nutKey === 'K' ? targetK : targetMg)); model.constraints[`${nutKey}Target`] = { equal: targetValue / 100 }; });
            if (!useMg) { const mgFertIndex = FERTILIZER_NAMES.indexOf(MG_FERT_NAME); if (mgFertIndex !== -1) { const mgVarName = `f${mgFertIndex}`; if (model.variables[mgVarName]) { const constraintName = `mgZeroConstraint`; model.constraints[constraintName] = { equal: 0 }; model.variables[mgVarName][constraintName] = 1; console.log(`Added constraint: ${mgVarName} = 0`); } } }
            console.log("LP Model (Equal Weights):", JSON.stringify(model, null, 2)); let solution = null;
            try { if (typeof solver === 'undefined' || typeof solver.Solve !== 'function') { throw new Error("Biblioteka jsLPSolver nie została załadowana poprawnie."); } solution = solver.Solve(model); console.log("LP Solution:", solution); } catch (e) { console.error("Error solving LP:", e); return { success: false, message: `Błąd podczas rozwiązywania problemu optymalizacji: ${e.message}` }; }
            if (!solution || !solution.feasible) { console.error("Infeasible solution details from solver:", solution); return { success: false, message: "Nie znaleziono wykonalnego rozwiązania. Sprawdź, czy zadane wartości docelowe są możliwe do osiągnięcia przy użyciu dostępnych nawozów." }; }
            const finalPercentages = new Array(numFertilizers).fill(0); let calculatedSum = 0; for (let i = 0; i < numFertilizers; i++) { finalPercentages[i] = (solution[`f${i}`] || 0) * 100; calculatedSum += finalPercentages[i]; }
             if (Math.abs(calculatedSum - 100) > 0.1) { console.warn(`Sum normalization needed: ${calculatedSum}`); if (calculatedSum > 0) { const scale = 100 / calculatedSum; for (let i = 0; i < numFertilizers; i++) { finalPercentages[i] *= scale; } } }
             for (let i = 0; i < numFertilizers; i++) { finalPercentages[i] = Math.max(0, finalPercentages[i]); }
            const finalEval = evaluateCombination(finalPercentages.map(p => p / 100), totalMass, inputs); const finalBestCombination = { percentages: finalPercentages, nutrients: finalEval.nutrients, cost: finalEval.cost, score: finalEval.errorScore, optimizationGoal: 'accuracy' };
             const tolerances = { N: ABSOLUTE_TOLERANCE.N, P: ABSOLUTE_TOLERANCE.P, K: ABSOLUTE_TOLERANCE.K, Mg: useMg ? ABSOLUTE_TOLERANCE.Mg : 0 };
            return { success: true, solution: { bestCombination: finalBestCombination, tolerances: tolerances } };
        }


        // --- Input/Display/HTML Generation/PDF Functions ---
        function showError(message) { statusMessageContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Błąd!</strong> <span class="block sm:inline ml-2">${message}</span></div>`; resultDiv.style.display = 'block'; resultTableContainer.innerHTML = ''; costInfoContainer.innerHTML = ''; finalCompContainer.innerHTML = ''; hintsContainer.innerHTML = ''; loaderContainer.style.display = 'none'; calculateButton.disabled = false; }

        // --- *** NEW Function: generateHints *** ---
        function generateHints(bestCombination, inputs, tolerances) {
            const { nutrients, percentages } = bestCombination;
            const { targetN, targetP, targetK, useMg, targetMg } = inputs;
            const { N: rN, P: rP, K: rK } = nutrients;

            let hints = [];
            const diffN = rN - targetN;
            const diffP = rP - targetP;
            const diffK = rK - targetK;

            const isNOutside = Math.abs(diffN) > tolerances.N;
            const isPOutside = Math.abs(diffP) > tolerances.P;
            const isKOutside = Math.abs(diffK) > tolerances.K;

            // Helper to find main sources contributing to N, P, K
            const findMainContributors = (nutrientKey, threshold = 5) => {
                const dataKey = nutrientKey === 'P' ? 'P' : (nutrientKey === 'K' ? 'K' : nutrientKey);
                const sources = [];
                FERTILIZER_NAMES.forEach((name, i) => {
                    if (percentages[i] > 1.0 && FERTILIZER_DATA[name][dataKey] > threshold) {
                         sources.push({ name, perc: percentages[i], value: FERTILIZER_DATA[name][dataKey] });
                    }
                });
                sources.sort((a, b) => b.perc * b.value - a.perc * a.value);
                return sources.slice(0, 2).map(s => s.name);
            };

             // Hint for High Nitrogen when Target N is Low
             if (isNOutside && diffN > 0 && targetN < (rN / 1.5)) {
                 const pSources = findMainContributors('P');
                 const kSources = findMainContributors('K');
                 const nContainingPKSources = [...pSources, ...kSources].filter(name => FERTILIZER_DATA[name].N > 0);
                 if (nContainingPKSources.length > 0) {
                     hints.push(`Wysoki poziom azotu (N ≈ ${rN.toFixed(1)}%) może wynikać z konieczności użycia nawozów P/K, które również zawierają N (np. ${[...new Set(nContainingPKSources)].join(', ')}). Rozważ zwiększenie celu dla N lub lekkie zmniejszenie celu dla P i/lub K.`);
                 }
             }
             // Hint for High P when Target P is Low
             if (isPOutside && diffP > 0 && targetP < (rP / 1.5)) {
                 const nSources = findMainContributors('N');
                 const kSources = findMainContributors('K');
                 const pContainingNKSources = [...nSources, ...kSources].filter(name => FERTILIZER_DATA[name].P > 0);
                 if (pContainingNKSources.length > 0) {
                     hints.push(`Wysoki poziom fosforu (P ≈ ${rP.toFixed(1)}%) może wynikać z użycia nawozów N/K, które również zawierają P (np. ${[...new Set(pContainingNKSources)].join(', ')}). Rozważ modyfikację celów N/K lub P.`);
                 }
             }
             // Hint for High K when Target K is Low
              if (isKOutside && diffK > 0 && targetK < (rK / 1.5)) {
                 const nSources = findMainContributors('N');
                 const pSources = findMainContributors('P');
                 const kContainingNPSources = [...nSources, ...pSources].filter(name => FERTILIZER_DATA[name].K > 0);
                 if (kContainingNPSources.length > 0) {
                     hints.push(`Wysoki poziom potasu (K ≈ ${rK.toFixed(1)}%) może wynikać z użycia nawozów N/P, które również zawierają K (np. ${[...new Set(kContainingNPSources)].join(', ')}). Rozważ modyfikację celów N/P lub K.`);
                 }
             }

             // *** NEW HINT: Suggest using Mg as filler ***
             if (!useMg) { // Only suggest if Mg is currently NOT used
                 hints.push(`Czasami zaznaczenie opcji 'Uwzględnij Magnez' (nawet z celem 0 lub niskim) pozwala algorytmowi użyć siarczanu magnezu jako 'wypełniacza' bez NPK, co może poprawić bilans głównych składników, jeśli trudno jest osiągnąć 100% sumy bez ich nadmiaru.`);
             }
             // *** END NEW HINT ***


             // General hint if still outside tolerance and no specific hint was added
             if (hints.length === 0 && (isNOutside || isPOutside || isKOutside)) {
                  hints.push(`Osiągnięcie zadanych proporcji NPK z dokładnością ±${tolerances.N.toFixed(1)}% jest trudne przy użyciu dostępnych nawozów. Rozważ nieznaczną modyfikację wartości docelowych.`);
             }


            if (hints.length > 0) {
                return `<div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="font-semibold text-yellow-800 mb-1">Wskazówki dotyczące wyniku:</p><ul class="list-disc list-inside space-y-1 text-yellow-700">${hints.map(h => `<li>${h}</li>`).join('')}</ul></div>`;
            }
            return "";
        }

        // --- Modified displayResults ---
        function displayResults(resultsData, inputs) {
            const { bestCombination, tolerances } = resultsData; const { totalMass, useMg } = inputs;
            hintsContainer.innerHTML = ''; // Wyczyść wskazówki

            if (!bestCombination) { showError("Wystąpił nieoczekiwany błąd - brak wyników."); return; }
            const { percentages, nutrients, cost } = bestCombination;
            const isWithinTolerance = checkTolerance(nutrients, inputs, tolerances);
            let statusMessage = ""; let statusClass = "";

            if (isWithinTolerance) { statusMessage = `✅ Sukces! Znaleziono optymalną mieszankę NPK w zadanych granicach tolerancji (±${tolerances.N.toFixed(1)}%).`; statusClass = "bg-green-100 border-green-400 text-green-700"; }
            else { statusMessage = `⚠️ Uwaga: Optymalna znaleziona mieszanka NPK nadal odbiega od celu poza zakresem tolerancji (±${tolerances.N.toFixed(1)}%). Sprawdź szczegóły poniżej.`; statusClass = "bg-yellow-100 border-yellow-400 text-yellow-700";
                // Generuj i wyświetl wskazówki tylko jeśli wynik jest poza tolerancją
                hintsContainer.innerHTML = generateHints(bestCombination, inputs, tolerances);
             }
            statusMessageContainer.innerHTML = `<div class="${statusClass} border px-4 py-3 rounded-lg relative" role="alert">${statusMessage}</div>`;

            resultTableContainer.innerHTML = generateCompositionTable(percentages, totalMass); costInfoContainer.innerHTML = generateCostTable(percentages, totalMass, cost); finalCompContainer.innerHTML = generateNutrientResultTable(inputs, nutrients, tolerances);
            resultDiv.style.display = 'block';
            loaderContainer.style.display = 'none';
        }

        // --- Pozostałe funkcje generujące HTML (bez zmian) ---
        function generateCompositionTable(percentages, totalMass) { let html = `<h3 class="text-lg font-semibold text-gray-800 mb-3">Składniki Mieszanki NPK:</h3><div class="overflow-x-auto mb-6 shadow-sm rounded-lg border border-gray-200"><table class="min-w-full bg-white text-sm"><thead><tr class="bg-gray-50"><th class="px-4 py-2 border-b text-left font-semibold text-gray-600">Nawóz</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">%</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Ilość [kg]</th></tr></thead><tbody class="divide-y divide-gray-200">`; let tcM = 0; let acSP = 0; FERTILIZER_NAMES.forEach((name, i) => { const p = percentages[i]; if (p > 0.01) { const aK = (p / 100) * totalMass; tcM += aK; acSP += p; html += `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${name}</td><td class="px-4 py-2 text-right">${p.toFixed(1)}</td><td class="px-4 py-2 text-right">${aK.toFixed(2)}</td></tr>`; } }); html += `<tr class="bg-gray-100 font-semibold"><td class="px-4 py-2 text-left" colspan="1">Suma:</td><td class="px-4 py-2 text-right">${acSP.toFixed(1)}</td><td class="px-4 py-2 text-right">${tcM.toFixed(2)}</td></tr></tbody></table></div>`; return html; }
        function generateCostTable(percentages, totalMass, totalCost) { let html = `<h3 class="text-lg font-semibold text-gray-800 mb-3">Szacowany Koszt Mieszanki NPK:</h3><div class="overflow-x-auto mb-6 shadow-sm rounded-lg border border-gray-200"><table class="min-w-full bg-white text-sm"><thead><tr class="bg-gray-50"><th class="px-4 py-2 border-b text-left font-semibold text-gray-600">Nawóz</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Ilość [kg]</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Cena/25kg [zł]</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Koszt [zł]</th></tr></thead><tbody class="divide-y divide-gray-200">`; FERTILIZER_NAMES.forEach((name, i) => { const p = percentages[i]; if (p > 0.01) { const aK = (p / 100) * totalMass; const p25 = FERTILIZER_PRICES[name] || 0; const c = (aK / 25) * p25; html += `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${name}</td><td class="px-4 py-2 text-right">${aK.toFixed(2)}</td><td class="px-4 py-2 text-right">${p25.toFixed(2)}</td><td class="px-4 py-2 text-right">${c.toFixed(2)}</td></tr>`; } }); html += `<tr class="bg-indigo-50 font-bold"><td class="px-4 py-2 text-left text-indigo-800" colspan="3">Całkowity koszt (${totalMass.toFixed(1)} kg):</td><td class="px-4 py-2 text-right text-indigo-800">${totalCost.toFixed(2)} zł</td></tr>`; html += `<tr class="bg-indigo-50 font-semibold"><td class="px-4 py-2 text-left text-indigo-800" colspan="3">Koszt za 1 kg:</td><td class="px-4 py-2 text-right text-indigo-800">${(totalCost / totalMass).toFixed(2)} zł</td></tr></tbody></table></div>`; return html; }
        function generateNutrientResultTable(inputs, nutrients, tolerances) { const { targetN, targetP, targetK, targetMg, useMg } = inputs; const { N: rN, P: rP, K: rK, Mg: rMg, S: rS } = nutrients; let html = `<h3 class="text-lg font-semibold text-gray-800 mb-3">Wynikowa Mieszanka NPK:</h3><div class="overflow-x-auto shadow-sm rounded-lg border border-gray-200"><table class="min-w-full bg-white text-sm"><thead><tr class="bg-gray-50"><th class="px-4 py-2 border-b text-left font-semibold text-gray-600">Składnik</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Docelowo [%]</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Uzyskano [%]</th><th class="px-4 py-2 border-b text-right font-semibold text-gray-600">Różnica [%]</th></tr></thead><tbody class="divide-y divide-gray-200">`; const fNR = (n, t, r, tol) => { if (t === null || t === undefined) return ''; const d = r - t; let dC = 'text-gray-700'; if (Math.abs(d) > tol) dC = 'text-red-600 font-bold'; else if (Math.abs(d) > 0.01) dC = 'text-yellow-600'; const tH = `<span class="tooltip info-icon">? <span class="tooltiptext">Tolerancja: ±${tol.toFixed(2)}%</span></span>`; return `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${n}</td><td class="px-4 py-2 text-right">${t.toFixed(2)}</td><td class="px-4 py-2 text-right font-semibold text-gray-900">${r.toFixed(2)} ${tH}</td><td class="px-4 py-2 text-right ${dC}">${d.toFixed(2)}</td></tr>`; }; html += fNR('Azot (N)', targetN, rN, tolerances.N); html += fNR('Fosfor (P₂O₅)', targetP, rP, tolerances.P); html += fNR('Potas (K₂O)', targetK, rK, tolerances.K); if (useMg) { html += fNR('Magnez (Mg)', targetMg, rMg, tolerances.Mg); } html += `<tr class="hover:bg-gray-50"><td class="px-4 py-2">Siarka (S)</td><td class="px-4 py-2 text-right">-</td><td class="px-4 py-2 text-right font-semibold">${rS.toFixed(2)}</td><td class="px-4 py-2 text-right">-</td></tr>`; html += `</tbody></table></div>`; return html; }

        // --- Pozostałe funkcje (renderChart, exportToPDF, etc. - zaślepkowe) ---
        function renderChart(inputs, resultNutrients) { /* Pominięto */ }
        function exportToPDF(resultsData) { alert("Eksport do PDF nie jest dostępny w tej wersji."); }
        function calculateDosing(inputs, resultNutrients) { /* Pominięto */ return null; }
        function generateDosingResultHTML(dosingResult, inputs) { return ""; }

        // --- Initialization ---
        targetMgInput.disabled = !useMgCheckbox.checked;
        document.getElementById('currentYear').textContent = new Date().getFullYear();

    </script>

</body>
</html>
